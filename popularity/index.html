<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Popularity Ranking</title>
    <link rel="stylesheet" href="../assets/css/bootstrap.css">
    <link rel="stylesheet" href="../assets/css/xenon-core.css">
    <link rel="stylesheet" href="../assets/css/xenon-components.css">
    <link rel="stylesheet" href="../assets/css/xenon-skins.css">
    <link rel="stylesheet" href="../assets/css/nav.css">
    <style>
        body { background: #fafbfc; }
        .popularity-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .popularity-title { font-size: 2rem; font-weight: bold; }
        .popularity-filters { display: flex; gap: 16px; }
        .popularity-filters .form-control { min-width: 160px; max-width: 220px; }
        .table th, .table td { vertical-align: middle !important; }
        .multiselect {
            min-width: 120px;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 4px 8px;
            background: #fff;
        }
        .multiselect label { display: block; margin-bottom: 2px; }
    </style>
</head>
<body>
<div class="container" style="margin-top:40px;">
    <div class="popularity-header">
        <div class="popularity-title">Popularity</div>
        <div class="popularity-filters">
            <select id="regionSelect" class="form-control">
                <option value="global">Global</option>
                <option value="china">Thailand</option>
            </select>
            <select id="timeSelect" class="form-control">
                <option value="7">Last 7 days</option>
                <option value="30">Last 14 days</option>
                <option value="90">Last 90 days</option>
            </select>
        </div>
    </div>
    <div class="row" style="margin-bottom:16px;">
        <div class="col-md-3">
            <div class="multiselect" id="nationalityFilter">
                <strong>Nationality</strong>
                <label><input type="checkbox" value="Chinese" checked> All</label>
                <label><input type="checkbox" value="Chinese" checked> Chinese</label>
                <label><input type="checkbox" value="Korean"> Korean</label>
                <label><input type="checkbox" value="Japanese"> Japanese</label>
            </div>
        </div>
        <div class="col-md-3">
            <div class="multiselect" id="occupationFilter">
                <strong>Occupation Type</strong>
                <label><input type="checkbox" value="Actress" checked> All</label>
                <label><input type="checkbox" value="Actress" checked> Actress</label>
                <label><input type="checkbox" value="Actor" checked> Actor</label>
                <label><input type="checkbox" value="Singer"> Singer</label>
            </div>
        </div>
    </div>
    <table class="table table-bordered table-hover">
        <thead>
        <tr>
            <th style="width:40px;">#</th>
            <th>Talent (CN/EN)</th>
            <th>Nationality</th>
            <th>Popularity</th>
            <th>Occupation Type</th>
        </tr>
        </thead>
        <tbody id="popularityTableBody">
        <!-- 数据行由JS渲染 -->
        </tbody>
    </table>
</div>
<script src="../assets/js/jquery-1.11.1.min.js"></script>
<script>
// 静态映射（后续可用接口动态获取）
const nationalityMap = {
    'Chinese': 1,
    'Korean': 2,
    'Japanese': 3
};
const occupationMap = {
    'Actress': 1,
    'Actor': 2,
    'Singer': 3
};

const dimensionMap = {
    'global': 'worldwide',
    'china': 'weibo',
    'us': 'us' // 这里us仅占位，实际API未必支持
};
const periodMap = {
    '7': '7day',
    '30': '14day',
    '90': '90day'
};

function getSelectedValues(selector) {
    return $(selector + ' input:checked').map(function() { return this.value; }).get();
}

function renderTable(data) {
    const tbody = $('#popularityTableBody');
    tbody.empty();
    if (!data || data.length === 0) {
        tbody.append('<tr><td colspan="5" style="text-align:center;color:#888;">No data</td></tr>');
        return;
    }
    data.forEach((item, idx) => {
        tbody.append(`
            <tr>
                <td>${item.popularity_rank || idx + 1}</td>
                <td>${item.talent_name_sc}<br><span style="color:#888;font-size:13px;">${item.talent_name_en_us || ''}</span></td>
                <td>${item.nationality || ''}</td>
                <td>${item.popularity ? item.popularity.toLocaleString() : ''}</td>
                <td>${item.occupation_type || ''}</td>
            </tr>
        `);
    });
}

function fetchData() {
    const selectedNationalities = getSelectedValues('#nationalityFilter');
    const selectedOccupations = getSelectedValues('#occupationFilter');
    const region = $('#regionSelect').val();
    const time = $('#timeSelect').val();

    // 这里只取第一个国籍和职业（如需多选支持后端需支持数组参数）
    const region_id = nationalityMap[selectedNationalities[0]] || '';
    const classifications_id = occupationMap[selectedOccupations[0]] || '';
    const dimension = dimensionMap[region] || 'worldwide';
    const period = periodMap[time] || '7day';

    // 组装参数
    const params = {
        period,
        dimension
    };
    if (classifications_id) params.classifications_id = classifications_id;
    if (region_id) params.region_id = region_id;

    // 请求API
    $.ajax({
        url: 'https://cpulse-be-staging.ivideocloud.cn/api/v1/admin/data_monitoring_talent',
        method: 'GET',
        data: params,
        success: function(res) {
            if (res && res.data && res.data.data) {
                // 这里 occupation_type/nationality 需后端返回或前端映射
                const data = res.data.data.map(item => ({
                    ...item,
                    nationality: selectedNationalities[0] || '',
                    occupation_type: selectedOccupations[0] || ''
                }));
                renderTable(data);
            } else {
                renderTable([]);
            }
        },
        error: function() {
            renderTable([]);
        }
    });
}

$('#nationalityFilter input, #occupationFilter input').on('change', fetchData);
$('#regionSelect, #timeSelect').on('change', fetchData);

// 初始化
$(function() {
    fetchData();
});
</script>
</body>
</html> 